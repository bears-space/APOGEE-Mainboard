<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>OTA Update</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 24px; max-width: 720px; }
    .card { padding: 16px; border: 1px solid #3333; border-radius: 12px; }
    button { padding: 10px 14px; border-radius: 10px; border: 1px solid #3333; cursor: pointer; }
    button:disabled { opacity: .6; cursor: not-allowed; }
    progress { width: 100%; height: 18px; }
    .row { display: flex; gap: 12px; align-items: center; flex-wrap: wrap; }
    code { background: #00000010; padding: 2px 6px; border-radius: 6px; }
    .status { white-space: pre-wrap; font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
  </style>
</head>
<body>
  <h1>OTA Update</h1>

  <div class="card">
    <div class="row">
      <input id="file" type="file" accept=".bin,application/octet-stream" />
      <button id="btn">Upload</button>
    </div>

    <div style="margin-top:14px">
      <progress id="prog" value="0" max="100"></progress>
      <div id="pct">0%</div>
    </div>

    <div style="margin-top:14px" class="status" id="status">Bereit.</div>

    <p style="margin-top:14px">
      Endpoint: <code id="ep">/update</code>
    </p>
  </div>

  <script>
    const UPDATE_URL = "/update";

    const elFile = document.getElementById("file");
    const elBtn  = document.getElementById("btn");
    const elProg = document.getElementById("prog");
    const elPct  = document.getElementById("pct");
    const elStat = document.getElementById("status");
    const elEp   = document.getElementById("ep");
    elEp.textContent = UPDATE_URL;

    function setStatus(msg) { elStat.textContent = msg; }
    function setProgress(p) {
      const v = Math.max(0, Math.min(100, p));
      elProg.value = v;
      elPct.textContent = `${v.toFixed(1)}%`;
    }

    elBtn.onclick = async () => {
      const file = elFile.files?.[0];
      if (!file) {
        setStatus("Fehler: keine Datei ausgewählt.");
        return;
      }

      elBtn.disabled = true;
      setProgress(0);
      setStatus(`Upload startet...\nDatei: ${file.name} (${file.size} bytes)\nPOST ${UPDATE_URL}`);

      const xhr = new XMLHttpRequest();
      xhr.open("POST", UPDATE_URL, true);
      xhr.setRequestHeader("Content-Type", "application/octet-stream");

      xhr.upload.onprogress = (e) => {
        if (e.lengthComputable) {
          setProgress((e.loaded / e.total) * 100);
        } else {
          setStatus(`Upload läuft... (bytes: ${e.loaded})`);
        }
      };

      xhr.onload = () => {
        const ok = xhr.status >= 200 && xhr.status < 300;
        setProgress(ok ? 100 : elProg.value);

        setStatus(
          `Fertig.\nHTTP ${xhr.status}\nResponse:\n${xhr.responseText || "(leer)"}\n\n` +
          (ok ? "Wenn das Gerät jetzt rebootet: alles gut ✅" : "Das sieht nach Fehler aus ❌")
        );

        elBtn.disabled = false;
      };

      xhr.onerror = () => {
        setStatus("Netzwerkfehler (oder ESP reboot während Response) — kann trotzdem success sein, wenn OTA direkt rebootet.");
        elBtn.disabled = false;
      };

      xhr.send(file);
    };
  </script>
</body>
</html>
